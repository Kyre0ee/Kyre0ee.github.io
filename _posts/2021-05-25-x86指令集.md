---
layout: post
title: x86指令集
date: 2021-05-25 09:30
tags: 逆向
excerpt: "本文介绍x86体系结构的指令集以及编写简单的汇编程序加深理解。"
toc: true
---	
# x86 指令集

## 指令集概述

x86 指令集是 Intel 公司推出的一种常见的 CPU 指令集架构，广泛应用于个人计算机和服务器等领域。x86 指令集包括大量的指令，涵盖了数据传输、算术逻辑运算、控制转移、浮点运算等方面。

### 数据传输指令

数据传输指令用于在寄存器之间或者寄存器与内存之间传输数据。常见的数据传输指令包括：

- MOV：将数据从一个位置复制到另一个位置。
- PUSH：将数据压入栈顶。
- POP：从栈顶弹出数据。

### 算术逻辑指令

算术逻辑指令用于执行数学运算和逻辑操作。常见的算术逻辑指令包括：

- ADD：加法运算。
- SUB：减法运算。
- MUL：乘法运算。
- DIV：除法运算。
- AND：逻辑与操作。
- OR：逻辑或操作。
- XOR：逻辑异或操作。

### 控制转移指令

控制转移指令用于控制程序的执行流程，包括条件跳转和无条件跳转。常见的控制转移指令包括：

- JMP：无条件跳转。
- JZ：零标志位时跳转。
- JNZ：非零标志位时跳转。
- JE：相等时跳转。
- JNE：不相等时跳转。

### 浮点运算指令

浮点运算指令用于执行浮点数的运算操作，包括加减乘除、开方、取倒数等。常见的浮点运算指令包括：

- FADD：浮点加法。
- FSUB：浮点减法。
- FMUL：浮点乘法。
- FDIV：浮点除法。
- FSQRT：浮点开方。

### 其他指令

除了上述基本的指令类型，x86 指令集还包括许多其他类型的指令，如字符串操作指令（如MOVSB、LODSB、STOSB）、位操作指令（如SHL、SHR、ROL、ROR）等

## 主要特点

- 复杂度：x86 指令集非常庞大，包含了大量的指令和特殊用途寄存器，因此具有较高的复杂度。
- 变长指令格式：x86 指令格式可以是不定长的，通常包含操作码、操作数和寻址方式等字段。
- CISC 架构：x86 指令集属于复杂指令集计算机（CISC）架构，具有丰富的指令集和灵活的寻址模式。

## 学习建议

了解基本指令集：首先学习常见的数据传输指令、算术逻辑指令和控制转移指令，掌握它们的功能和使用方法。
## 实践编程：通过编写简单的 x86 汇编程序来加深对指令集的理解，掌握汇编语言的基本语法和编程技巧。
### 汇编语言基本语法

x86 汇编语言的语法因汇编器而异，但常见的汇编器（如 NASM、MASM、GAS）的基本语法是相似的。汇编语言的主要组成部分包括指令、操作数、标号和伪指令。

1. 标号（Label）
标号用于标识程序中的某个位置，通常用于跳转指令的目标位置。标号以冒号（:）结尾。

```asm
start:
    ; some instructions
```

2. 指令（Instruction）
指令是汇编程序的核心，用于执行各种操作。每条指令由指令名和操作数组成。

```asm
MOV AX, 1  ; 将 1 赋值给 AX 寄存器
```

3. 操作数（Operand）
操作数可以是寄存器、内存地址、立即数等。操作数的类型和数量取决于指令。

```asm
ADD AX, BX  ; 将 BX 寄存器的值加到 AX 寄存器上
```

4. 伪指令（Pseudo-instruction）
伪指令不直接转换为机器码，而是由汇编器处理，如数据定义和段定义指令。

```asm
section .data  ; 定义数据段
section .text  ; 定义代码段
```

### 汇编语言编程技巧

- 理解寄存器的使用：x86 体系结构有多个寄存器，每个寄存器都有特定的用途，如通用寄存器（AX、BX、CX、DX）、段寄存器（CS、DS、ES、SS）、指针寄存器（SP、BP）、索引寄存器（SI、DI）等。
- 合理使用栈：栈是一个重要的数据结构，用于保存函数调用的上下文。使用 PUSH 和 POP 指令操作栈。
- 使用宏和子程序：宏和子程序有助于减少代码重复，提高代码可读性和可维护性。
- 注释代码：良好的注释有助于理解代码逻辑，尤其是在复杂的汇编程序中。

### 示例程序

下面是一个简单的 x86 汇编程序，使用 NASM 汇编器编写。该程序从标准输入读取两个整数，计算它们的和并打印结果。

#### 示例程序代码（x86 汇编）

```asm

section .data
    prompt1 db "Enter first number: ", 0
    prompt2 db "Enter second number: ", 0
    result_msg db "The sum is: ", 0

section .bss
    num1 resb 4
    num2 resb 4
    sum resb 4

section .text
    global _start

_start:
    ; Print prompt1
    mov eax, 4           ; sys_write
    mov ebx, 1           ; file descriptor (stdout)
    mov ecx, prompt1     ; message to write
    mov edx, 18          ; message length
    int 0x80

    ; Read num1
    mov eax, 3           ; sys_read
    mov ebx, 0           ; file descriptor (stdin)
    mov ecx, num1        ; buffer to read into
    mov edx, 4           ; number of bytes to read
    int 0x80

    ; Print prompt2
    mov eax, 4           ; sys_write
    mov ebx, 1           ; file descriptor (stdout)
    mov ecx, prompt2     ; message to write
    mov edx, 19          ; message length
    int 0x80

    ; Read num2
    mov eax, 3           ; sys_read
    mov ebx, 0           ; file descriptor (stdin)
    mov ecx, num2        ; buffer to read into
    mov edx, 4           ; number of bytes to read
    int 0x80

    ; Convert num1 and num2 from ASCII to integer
    sub byte [num1], '0'
    sub byte [num2], '0'

    ; Calculate sum
    movzx eax, byte [num1]
    add eax, [num2]
    add eax, '0'
    mov [sum], eax

    ; Print result message
    mov eax, 4           ; sys_write
    mov ebx, 1           ; file descriptor (stdout)
    mov ecx, result_msg  ; message to write
    mov edx, 12          ; message length
    int 0x80

    ; Print sum
    mov eax, 4           ; sys_write
    mov ebx, 1           ; file descriptor (stdout)
    mov ecx, sum         ; buffer to write
    mov edx, 1           ; number of bytes to write
    int 0x80

    ; Exit program
    mov eax, 1           ; sys_exit
    xor ebx, ebx         ; exit code 0
    int 0x80
```

#### 解释示例程序

1. 数据段和未初始化数据段：

  - section .data：定义已初始化的数据段，包括提示消息和结果消息。
  - section .bss：定义未初始化的数据段，包括存储输入数字和计算结果的缓冲区。

2. 文本段：

  - section .text：定义代码段，包括程序的主要逻辑。
  - global _start：定义程序的入口点。

3. 读取和打印数据：

  - 使用系统调用 sys_write 打印提示信息。
  - 使用系统调用 sys_read 从标准输入读取数据。

4. 数据转换和计算：

  - 将读取的 ASCII 字符转换为整数进行加法运算。
  - 将计算结果转换回 ASCII 字符以便输出。

5. 输出结果和退出：

  - 使用系统调用 sys_write 打印结果消息和计算结果。
  - 使用系统调用 sys_exit 退出程序。
