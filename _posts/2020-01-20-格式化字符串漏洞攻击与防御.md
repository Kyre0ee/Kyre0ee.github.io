---
layout: post
title: 格式化字符串漏洞攻击与防御
date: 2020-01-20 09:30
tags: 二进制安全
excerpt: "本文介绍二进制安全漏洞-格式化字符串漏洞。"
toc: true
---	
# 格式化字符串漏洞 (Format String Vulnerabilities)
## 描述

格式化字符串漏洞是由于格式化输入未经过滤直接传递给格式化函数（如printf）而导致的安全问题。攻击者可以利用这个漏洞读取或写入内存数据，甚至控制程序的执行流程。这类漏洞主要出现在C和C++程序中，这些程序直接使用用户输入作为格式化字符串，而没有进行适当的检查或过滤。

## 案例
以下是一个简单的格式化字符串漏洞示例：

```c
#include <stdio.h>

void vulnerable_function(char *user_input) {
    printf(user_input); // 直接使用用户输入作为格式化字符串
}

int main() {
    char input[100];
    gets(input); // 获取用户输入，没有长度限制
    vulnerable_function(input);
    return 0;
}
```

在这个示例中，vulnerable_function函数直接将用户输入传递给printf函数作为格式化字符串。攻击者可以在输入中插入格式化指令（如%x、%s等）来读取内存中的数据，甚至可以通过特殊构造的输入覆盖内存地址，达到执行任意代码的目的。

### 漏洞利用示例

假设攻击者输入：

```perl
"%x %x %x %x"
```

printf函数会将输入解析为格式化字符串，并输出程序栈上的四个整数，这些整数是内存地址或数据。

更复杂的攻击可以利用%n格式说明符将用户输入的数据写入任意内存地址，从而改变程序的执行流。

## 防御手段

### 使用安全函数

避免直接使用不可信的用户输入作为格式化字符串。使用安全的字符串操作函数，如snprintf、vsnprintf等，可以显著降低格式化字符串漏洞的风险。

```c
void safe_function(char *user_input) {
    char buffer[200];
    snprintf(buffer, sizeof(buffer), "%s", user_input);
    printf("%s", buffer);
}
```

### 显式指定格式化字符串

在调用printf等格式化函数时，始终显式指定格式化字符串，避免直接使用用户输入。

```c
void safe_function(char *user_input) {
    printf("%s", user_input); // 显式指定格式化字符串
}
```

### 使用输入验证和过滤

对用户输入进行严格的验证和过滤，确保其不包含任何潜在的恶意格式化指令。

```c
#include <stdlib.h>
#include <string.h>

void safe_function(char *user_input) {
    char *sanitized_input = malloc(strlen(user_input) + 1);
    if (sanitized_input == NULL) {
        fprintf(stderr, "Memory allocation error\n");
        exit(EXIT_FAILURE);
    }
    strcpy(sanitized_input, user_input);
    // 对用户输入进行过滤
    for (char *p = sanitized_input; *p; p++) {
        if (*p == '%') {
            *p = '_'; // 将%替换为_或其他安全字符
        }
    }
    printf("%s", sanitized_input);
    free(sanitized_input);
}
```

### 启用编译器和运行时保护

一些现代编译器和运行时环境提供了额外的保护机制，帮助检测和防止格式化字符串漏洞。例如，启用编译器的格式字符串检查选项可以在编译时捕获潜在的问题。

```c
// 使用 -Wformat 和 -Wformat-security 编译选项来启用格式化字符串检查
gcc -Wformat -Wformat-security -o safe_program program.c
```

## 总结

格式化字符串漏洞是一种严重的安全隐患，了解其原理并采取相应的防御措施非常重要。通过使用安全函数、显式指定格式化字符串、对用户输入进行验证和过滤，以及启用编译器和运行时保护，可以有效降低格式化字符串漏洞的风险，提高程序的安全性。
