---
layout: post
title: 3.初识smail、跳转流程
date: 2023-05-13 23:18 +0800
tags:
  - 安卓逆向
toc: true
---
### 1.什么是jvm、Dalvik、ART
JVM是JAVA虚拟机，运行JAVA字节码程序
Dalvik是Google专门为Android设计得一个虚拟机，Dalvik有专属得文件执行格式dex(Dalvik executable)
Art(Android Runtime)相当于Dalvik得升级版，本质于Dalvik无异
### 2.smali及其语法
smali是Dalvik的寄存器语言，smali代码是dex反编译而来的
#### 2.1关键字

| 名称         | 注释            |
| :--------- | :------------ |
| .class     | 类名            |
| .super     | 父类名，继承的上级类名名称 |
| .source    | 源名            |
| .field     | 变量            |
| .method    | 方法名           |
| .register  | 寄存器           |
| .end       | 方法名的结束        |
| public     | 公有            |
| protected  | 半公开，只有同一家人才能用 |
| private    | 私有，只有自己能使用    |
| .parameter | 方法参数          |
| .prologue  | 方法开始          |
| .line xxx  | 位于第xxx行       |
#### 2.2数据类型对应
| smali类型      | java类型                | 注释         |
| :----------- | :-------------------- | ---------- |
| V            | void                  | 无返回值       |
| Z            | boolean               | 布尔类型，返回0或1 |
| B            | byte                  | 字节类型，返回字节  |
| S            | short                 | 短整数类型，返回数字 |
| C            | char                  | 字符类型，返回字符  |
| I            | int                   | 整数类型，返回数字  |
| J            | long(64位，需要两个寄存器存储)   | 长整数类型，返回数字 |
| F            | float                 | 单浮点类型，返回数字 |
| D            | double(64位，需要两个寄存器存储) | 双浮点类型，返回数字 |
| string       | string                | 文本类型，返回字符串 |
| Lxxx/xxx/xxx | object                | 对象类型，返回对象  |
#### 2.3常用指令

| 关键字          | 注释                               |
| :----------- | :------------------------------- |
| const        | 重写整数属性，真假属性内容，只能是数字类型            |
| const-string | 重写字符串内容                          |
| const-wide   | 重写长整数类型，多用于修改到期时间                |
| return       | 返回指令                             |
| if-eq        | 全程equal(a=b)，比较寄存器ab内容，相同则跳      |
| if-ne        | 全称not equal(a!=b)，ab内容不相同则跳      |
| if-eqz       | 全称equal zero(a=0),z即是0的标记，a等于0则跳 |
| if-nez       | 全称not equal zero(a!=0),a不等于0则跳   |
| if-ge        | 全称garden equal(a>=b),a大于或等于则跳    |
| if-le        | 全称little equal(a<=b),a小于或等于则跳    |
| goto         | 强制跳到指定位置                         |
| switch       | 分支跳转，一般会有多个分支线，并根据指令跳转到合适位置      |
| iget         | 获取寄存器数据                          |

#### 2.4smali语法-赋值
***
1. const/4 和const/16得区别？
4代表4字节，16代表16字节
2. Long型赋值
const-wide vx,lit32表示将一个32位得常量存储到vx与vx+1两个寄存器中--即一个long类型得数据
3. 变量赋值
可以全局搜索进行替换（.*）匹配所有得寄存器
### 3.寄存器
***
在smali里的所有操作都必须经过寄存器来进行：本地寄存器用v开头数字结尾的符号来表示，如v0、v1、v2,参数寄存器则使用p开头数字结尾的符号来表示，如p0、p1、p2。特别注意的是，p0不一定是函数中的第一个参数，在非static函数中，p0代指“this”,p1表示函数的第一个参数，p2代表函数中的第二个参数。而在static函数中p0才对应第一个参数（因为java的static方法中没有this方法）

### 5.逆向关键点
#### 1.快速定位(1.1 搜索关键字 1.2抓取按钮id)
#### 2.修改方法(2.1 修改判断 2.2 强制跳转 2.3 修改寄存器的值)

![[Pasted image 20240509105935.png]]

### 6.反思
对于开发者而言，在打包应用的时候，最好对代码进行混淆，否则逆向人员轻而易举得进行crack，或者说在写代码时不要用isvip、getvip等容易辨识得单词作为方法名。

