---
layout: post
title: 第三章 总线
date: 2019-05-03 15:57 +0800
tags: 计组-MIPS汇编
excerpt: "总线相关知识点"
toc: true
---
# 第三章
***
## 1.总线的基本概念
+ 计算机中三大部件的功能
  - 中央处理器（CPU）：执行指令（数据加工）
  - 主存储器（MM）:存储指令和数据
  - 输入/输出（I/O）:输入程序和数据，输出程序执行结果
  计算机所有功能都是通过CPU执行指令来实现，指令和数据保存在主存储器、磁盘中，或从键盘直接输入数据。
因此：在CPU和主存之间、CPU和键盘之间、主存和磁盘之间都需要有信息交换，需要有线路互连。这个互连的线路称为总线。
+ 用系统总线对主要功能部件进行互连。
  ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/a3b5ccaf-7911-460a-8097-34b22da6ccee)

+ 部件的功能和指令的执行过程
  - 每个指令周期完成不同的操作任务，这些任务涉及到
    * CPU从主存取指令、取数据
    * CPU把结果数据送主存
    * CPU送数据到I/O模块，或从I/O模块获得数据
    * 主存和I/O模块之间交换数据
    * I/O模块将中断请求信号送CPU
    * CPU从I/O模块读取中断向量；等等
  
+ 部件间的信息交换
  - CPU <->主存
    * CPU须给出所访问的主存单元的地址信息
    * CPU须给出读/写控制信息
    * CPU和主存之间有数据交换
  - CPU<->I/O模块
    * CPU须给出所访问的I/O模块的地址信息
    * CPU须给出读/写控制信息
    * CPU和I/O模块之间有数据交换
  - I/O模块<->主存
    * 在某些情况下I/O模块和主存之间可以直接交换数据
    * I/O模块(如DMA控制器)要能给出所访问主存单元的地址
    * I/O模块要能给出读/写控制信息
+ 部件的外部特性
  - 与其他部件间的互连信息（交换信息）
  - 各部件的输入/出信息 内部数据：主机侧来的，如CPU、主存 外部数据：外设送来的，如键盘、鼠标
    * 如何进行信息交换？ 通过在部件之间架设通信线路，进行互连。互连方式有分散结构和总线结构。
## 2.总线的分类及组成
+ 总线在各个层次上提供部件之间的连接和信息交换通路按不同的层次分为以下几类
  - 内部总线： 指芯片内部连接各元件的总线。例如CPU芯片内部，在各个寄存器、ALU、指令部件等各元件之间有总线相连。内部总线仅传输数据信息。
  - 系统总线：指连接CPU、存储器和各种I/O模块等主要部件的总线。又称板级总线或板间总线。系统总线上要传输数据、地址和控制信息。
    * 处理器总线：早期的Intel处理器总线称为前端总线，是主板上最快的总线，主要用作处理器与北桥芯片进行信息交换。
    * 存储器总线
      - 早期的存储器总线由北桥芯片控制，处理器通过北桥芯片和主存储器、图形卡以及南桥芯片进行互连。
      - Core i7以后的处理器芯片中集成了内存控制器，因而，存储器总线直接连接到处理器。
    * I/O总线：I/O总线用于为系统中的各种I/O设备提供输入/输出通路，在物理上通常是主板上的一些I/O扩展槽和连线。
  - 通信总线：这类总线用于主机和I/O设备之间或计算机系统之间的通信。
  ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/52bd9460-a0f2-4fd4-a732-56466ac58307)
北桥是主存控制器集线器芯片，通过MCH芯片，可直接访问主存和显存。
南桥是一个I/O控制器集线器芯片，其中可以集成USB控制器、磁盘控制器、以太网控制器等各种外设控制器也可以通过南桥芯片引出若干主板扩展槽，用以接插一些I/O控制卡。
+ 按总线的数据传输方式来分
  - 串行总线： 按位传输，一个方向只需一根数据线，成本低，适合于远距离数据传输
    * 近年出现高速串行总线
    * 波特率：每秒钟通过信道传输的码元数。也称码元传输速率，单位为位/秒（b/s）
      
  - 并行总线：同时有多位一起传送，每一位有一根数据线，故需多根数据线。
    * 可采用突发式传送：串行和并行相结合，在一个总线事务中连续传送多个字，字与字之间串行，字中每一位并行传输。
+ 系统总线的组成
  - 一个系统总线通常由一组控制线、一组数据线和一组地址线构成。
  - 也有些总线没有单独的地址线，地址信息通过数据线来传送，这种情况称为数据/地址复用。
    * 数据线：承载在源和目的部件之间传输的信息，如指令、操作数等。数据线的宽度反映一次能传送的数据的位数。
    * 地址线：给出源数据或目的数据所在的主存单元或I/O端口的地址。地址线的宽度反映最大的寻址空间。
    * 控制线：控制对数据线和地址线的访问和使用。用来传输定时信号和命令（读、写）等信息。典型的控制信号包括：
      - 时钟：用于总线同步
      - 复位：初始化所有设备
      - 总线请求：表明发出该请求信号的设备要使用总线
      - 总线允许：表明接收到该允许信号的设备可以使用总线
      - 中断请求：表明某个中断正在请求
      - 中断回答：表明某个中断请求已被接受
      - 存储器读：从指定的主存单元中读数据到数据总线上
      - 存储器写：将数据总线上的数据写到指定的主存单元中
      - I/O读： 从指定的I/O端口中读数据到数据总线上
      - I/O写：将数据总线上的数据写到指定的I/O端口中
      - 传输确认：表示数据已被接收或已被送到总线上
      
## 3.总线的特性和性能指标
总线是一组电导线，在部件间共享传输信息。
总线标准需规定以下基本特性：
+ 物理机械特性：连接类型、数量、接插件的几何尺寸和形状以及引脚线的排列等。
  - 连线类型：电缆式、主板式、底板式
  - 连线数量：串行总线、并行总线
+ 电气特性：每条信号线的信号传递方向、信号的有效电平范围
  - 信号方向：数据为双向、地址为单向、控制为单向
  - 电平表示方式：单端方式、差分方式
+ 功能特性：总线中每根传输线的功能
+ 时间特性：总线中任一根传输线在什么时间有效，以及每根线产生的信号之间的时序关系
尽管有不同实现方式，但总线设计基本要素和性能指标是类似的
+ 总线宽度： 数据线的宽度（8/16/32/64/128位...）
+ 信号线类型：专用信号线/复用信号线
+ 仲裁方式：集中式仲裁/分布式仲裁
+ 定时方式：同步通信/异步通信
+ 事务类型：所支持的数据传输类型和其他总线操作类型
+ 工作频率：早期总线一个时钟周期传送一次数据，工作频率等于时钟频率。现在一个时钟周期可以传送2次或4次数据故工作频率是时钟频率的2或4倍。
+ 总线带宽（最大数据传输率）：每秒钟在总线上能传输的最大字节数。
  - 处理器总线的带宽
    * 早期处理器总线称为前端总线，每个时钟传送一次，供时钟频率和工作频率一致。从pentium pro开始，fsb采用quad pumped技术在每个总线时钟周期内传4次数据总线数据传输率等于总线时钟频率的4倍。
    * Intel推出Core i7时，北桥芯片的功能被集成到CPU芯片内，cPU通过存储器总线直接和内存条相连，在CPU芯片内部的核与核之间、CPU芯片与其他CPU芯片之间，以及CPU芯片与IOH芯片之间则通过QPI总线相连。QPI总线是一种基于包传输的串行高速点对点连接协议。
    * QPI总线的带宽：发送和接收方各有时钟信号，每个时钟周期传输两次。QPI总线有20条数据线，一个QPI数据包包含80位，需要两个时钟周期或4次传输，才能完成整个数据包的传送。在每次传输的20位数据中，有16位是有效数据，其余4位用于循环冗余校验，以提高系统的可靠性。每个QPI总线的带宽计算公式：每秒传输次数*每次传输的有效数据*2
  - I/O总线的带宽
    * I/O总线
      + 用于为各种I/O设备提供输入/输出通路
      + 在物理上通常是主板上的一些I/O扩展槽
      + 早期的第一代I/O总线有XT总线、ISA总线、EISA总线、VESA总线这些I/O总线早已被淘汰
      + 第二代I/O总线包括PCI、AGP、PCI-x
      + 第三代I/O总线是PCI-Express,与前两代I/O总线采用并行传输的同步总线不同，PCI-Express总线采用串行传输方式。
      + 两个PCI-Express设备之间以一个链路相连，每个链路包含多条通路，可能的通路数位1、2、4、8、16、32。每条通路由发送和接收数据线构成，可同时发送和接受数据。在发送和接收过程中，每个数据自己实际上被替换成了10位信息被传输。
## 4.总线结构
+ 总线结构可分为
  - 单总线结构
    * 早期计算机采用单总线结构
      - CPU、主存与I/O模块之间的传送都通过一组总线进行，PDP-11和国产DJS183采用该结构
      - 优缺点：优点：体系结构简单、便于扩充。缺点：所有传送都共享一组总线，极易使总线成为整个系统的瓶颈，使性能下降。
      - 单总线结构性能下降的原因：总线上连接的设备越多，传输延迟就会越大。总线上挂接设备速度差异越大，效率越差。CPU也只能挂接在这个单一的总线上，不能从数据传送操作中解放出来。
   
  - 多总线结构
    * 双总线结构（不分层次/分层次）
      - 不分层次： 在单总线基础上再加一条CPU与主存之间的通路，形成以存储器为中心的双总线结构。国产DJS184机采用该结构
      - 分层次： 将I/O分离出来，集中由IOP管理。将原先的单总线分成主存总线和I/O总线，形成两级双总线结构。
    * 三总线结构（不分层次/分层次）
      - 不分层次： 在以主存为中心的双总线结构中，将I/O和主存从系统总线上分离开来，将原先的系统总线分成主存总线和I/O总线。而在主存和高速的磁盘等设备之间引入一个专门的DMA总线，形成三总线结构。
      - 分层次：CPU和cache间通过专门的局部总线相连，Cache同时与主存用主存总线相连。引入一条或多条扩展I/O总线，主机和扩展总线上I/O设备间的数据传送通过扩展总线接口来缓冲。
    * 多总线分层结构
      - 四总线结构：Cache在CPU芯片中，CPU通过前端局部总线通过I/O桥连接，I/O桥再通过存储器总线与主存连接。引入分层的I/O总线来连接各类外设。
## 5.总线裁决控制
+ 完成一次总线传输，分四个阶段：
  - 总线裁决：决定那个主控设备使用总线
  - 寻址阶段：主控设备送出要访问的主存设备的地址，同时送出有关命令（读或写等），启动从设备
  - 数据传输阶段：主、从设备间进行数据交换
  - 结束阶段：有关信息在总线上撤销，让出总线使用权
  - 完成一次总线传输就是完成一个总线事务。
+ 什么是总线裁决？ 总线判优控制：当多个设备需要使用总线进行通信时，采用某种策略选择一个设备使用总线。
+ 为什么需要进行总线裁决？ 因为总线是共享的传输介质，挂接在总线上的多个设备共享总线，因此，可能会同时有多个设备需要使用总线与另一个设备进行信息交换。
+ 如何进行总线判优控制？
  - 确定总线主控设备。主控设备：能发起总线请求并控制总线。如：CPU、IOP 从设备：只能响应从主控设备发来的总线命令。如：主存。
  - 利用总线裁决决定哪个主控设备将得到总线使用权。
  - 只有具有总线使用权的主控设备才能控制总线。
+ 总线裁决方式
  - 集中裁决方式：将总线控制逻辑做在一个专门的总线控制器（总线裁决器）中，通过将所有的总线请求集中起来，利用一个特定的裁决算法进行裁决。
  - 分布裁决方式：没有专门的总线控制器，其控制逻辑分散在各个部件或设备中。
+ 总线裁决信号线
  - 类型：总线请求线、总线许可线、总线忙
  - 使用方式：专用/复用 例如，用数据线进行总线请求，这种情况下，总线裁决和数据传输不能重叠进行。
+ 裁决方案应在以下两个因素间进行平衡。
  - 等级性--具有高优先级的设备应该先被服务。
  - 公平性--即使是具有最低优先权的设备也不能永远得不到总线使用权。
+ 集中式总线判优方式有三种：
  - 链式查询
    * 基本思想：三根线用于总线控制（BS-总线忙、BR-总线请求、BG-总线允许）。BG从最高优先权设备依次向最低设备串行传送。若BG到达的设备有总线请求，则BG信号不再往后传，该设备建立总线忙BS信号，表示它已获得了总线使用权。
    ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/82a4ba61-24a9-4007-ba6c-0477dd479df5)
    * 优点：简单，易扩充
    * 缺点：不能保证公正性、对电路故障敏感、链式查询速度变慢。
  - 计时器定时查询
    * 基本思想：比链式查询多一组设备线，无BG线。接收到总线请求信号后，在BS=0(不忙)的情况下，计数器计数，并将计数值有设备先发出。当某个有总线请求的设备与计数值一致时，该设备便获得总线使用权，此时终止计数查询，同时该设备建立总线忙BS信号。
    ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/2a76a41f-d916-4aa9-9f91-8b439d8b9172)
    * 优点：灵活（优先级可通过设置不同的计数初值而改变）、对电路故障不如链式查询那样敏感。
    * 缺点：增加了一组设备线、总线设备控制逻辑变复杂（需对设备号进行译码比较等）。
  - 独立请求
    * 基本思想：各设备有一对总线请求线和总线允许线。当某设备要使用总线时，对于总线请求线将请求信号送总线控制器。它有一个判优电路，可根据各设备优先级确定选择哪个设备使用总线。控制器可给各请求线以固定优先级，也可设置可编程优先级。
      ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/7e782c31-4422-4f76-8361-96b3b8c88d9d)

    * 优点：响应速度快，如果是可编程的总线控制器，则优先级可灵活设置。
    * 缺点：控制逻辑复杂，控制线量多。若n表示允许挂接的最大设备数，则链式查询只需要2根裁决线，计数查询大致需要log2N根裁决线，而独立请求方式需要2n根裁决线。
    * 裁决算法：由总线控制器中的硬件实现，可采用固定的并行判优算法、平等的循环链算法、动态优先级算法（如：最近最少使用算法、先来先服务算法）等。
    
## 6.总线通信控制
* 总线定时--按时间点约会
  - 什么是总线定时？总线通信控制：取得总线控制权后如何控制总线进行总线操作？即如何定义总线事务中的每一步何时开始、何时结束？
  - 总线通信控制的目的：解决主、从设备如何获知传输开始和传输结束，以及通信双方如何协调进行数据通信。
  - 四种定时方式：同步、异步、半同步、分离式通信
* 总线定时-同步控制
  - 同步控制方式
    + 有一个时钟信号线，总线上所有设备都从这个时钟线上获得定时信号，一定频率时钟信号定义了等间隔的时间段，这个固定时间段为一个时钟周期。
    + 每种总线操作有一个确定的通信协议（规定在每个时钟周期内交换哪些信息）。例如，在处理器-主存总线上执行存储器读操作，其协议为：在第一个时钟周期发送地址和存储器读命令，然后存储器被要求在第5个时钟周期将数据放到总线上。
    + 优点：可采用突发传输方式，速度快（一个总线事务可传输地址连续的多个数据）。接口逻辑少（因为协议简单）
    + 缺点：总线上每个设备必须以同样的时钟速率进行工作。由于时钟偏移问题，同步总线不能很长。
    + 总线传输周期：完成一次总线事务的时间，需要若干时钟周期。可采用突发传输方式：给出首地址，读写命令和突发长度后，在数据传输阶段连续进行多个数据读写。在数据传输阶段，可能一个时钟周期内传输多次数据，因此，工作频率等一时钟频率的若干倍。
      ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/c885d3d8-7903-4460-b1c4-adbd8e9c9dde)
  - 异步通信控制--按电话联系进行约会
    + 非时钟定时，没有一个公共的时钟信息。因此，能够连接带宽范围很大的各种设备。总线加长而不用担心时钟偏移问题。
    + 采用握手协议（应答方式）。由一系列步骤组成，只有当双方都同意时，发送者或接收者才会进入到下一步，西医通过一对附加的握手信号（Ready\ack）来实现。
    + 三条控制线，共需7次握手，包含两次应答过程分别用来传送地址和数据
      * ReadReq:读请求，告诉从设备进行读操作。地址信息同时送到地址/数据线上
      * DataRdy:数据就绪，从设备已准备好数据，主设备可取。数据同时送到地址/数据线上
      * Ack:回答信号线，表示已收到对方的请求信号
      ![image](https://github.com/Kyre0ee/Kyre0ee.github.io/assets/169347540/2a57bbeb-f777-4c7d-a0fb-0687bd9926e9)
    + 异步通信有非互锁、半互锁和全互锁三种方式
    + 优点：灵活，可挂接各种具有不同工作速度的设备。
    + 缺点：对噪声比较敏感（握手信号随时会发出），接口逻辑比较复杂。
  - 半同步通信控制
    + 为解决异步通信对噪声敏感的问题，一般在异步总线中引入时钟信号，就绪和应答等定时信号（如Wait信号、TRDY和IRDY信号等）在时钟信号到达时采样，使信号有效时间限制在时钟到达的时刻，而不受其他时间信号的干扰。
    + 半同步方式结合了同步和异步的优点。即保持了所有信号都由时钟定时的特点，又允许不同速度设备共存于总线。
  - 分离式通信控制
    + 将传输事务分成两个子过程
      * 子过程1：主控设备A在获的总线使用权后，将请求的事务类型（即总线命令）、地址以及其他有关信息（如标识主控设备身份的编号等）发送到总线上，从设备B记录下这些信息。A发完后便立即释放总线，其他设备便可使用总线。
      * 子过程2：B收到A发来的信息后，就按照其请求的命令进行相应的操作，当准备好A所需的数据后，B便请求使用总线，一旦获得使用权，则B就将A的编号及所需的数据送到总线上，这样A便可接收数据。
    + 优点：提高整个系统的总有效带宽。
    + 缺点：控制相当复杂，开销大。
# 第三章总结
***

