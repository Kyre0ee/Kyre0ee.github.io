---
layout: post
title: DNS隧道相关内容
date: 2024-05-17 09:30
tags: DNS隧道
toc: true
---
DNS是互联网的基本组成部分，它服务很多应用程序，从web浏览以及邮件、自动发现、安全监控等。由于其重要性，大多数企业实施对DNS流量的宽松政策。DNS的流量宽松策略允许攻击者访问互联网。FQDN (Fully Qualified Domain Name)全限定域名：同时带有主机名和域名符号。

# DNS隧道基础知识
## 1.什么是DNS隧道？
DNS隧道是一种技术：将不属于DNS协议的数据编码放在DNS的请求和响应中。使得通过DNS协议进行恶意通信包括文件传输，C2和web浏览。
## 2.DNS隧道用来做什么？
使用UDP的53端口。攻击者滥用DNS协议进行隧道C2通信并且获取恶意软件的payload。
## 3.使用DNS隧道的恶意软件
SUNBURST、OilRig、xHunt、DarkHydrus
## 4.DNS隧道如何执行？
客户端-->(发送DNS数据包到互联网)通过DNS请求编码内容，通过DNS响应解码内容。
服务器<--接收来自递归解析器的 DNS 查询，解码 DNS 查询的内容并将内容编码为 DNS 响应。
解析器-->迭代查询不同域级别的域名服务器，直到获得有效响应。
客户端<--接收并解码消息中的payload,如果该值超过单个DNS数据包的大小，客户端和服务器将分解它们并将它们作为多个查询和响应发送。
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/f88fbdd3-bd30-465a-b7a4-ea38484515a2)
通常使用编码算法对数据进行编码和分段。编码算法通过自定义状态实现。
## 5.DNS隧道工具
有一些现成的DNS隧道工具：iodine、DNSStager、dnscat2和sliver等开源应用程序，和Cobalt Strike等专有应用程序。这些工具支持将通用消息编码为DNS查询的子域和各种类型的DNS响应，例如A(IPV4地址)、AAAA(IPV6地址)、TXT、CNAME、MX。

# DNS隧道用来进行C2
C2是DNS隧道最著名的用例。
同一活动共享一些特征：1.用于通信的C2通用名称服务器
                    2.用于编码和解码的通用隧道工具
## 活动FinCounter:                    
特征：
1.同一个客户与多个隧道域进行通信 2.隧道域共享几个服务器IP 3.使用相同的底层编码攻击（使用以计数器开头的查询例如：10.c5f310abb43603a3af324ee92bea16c8132ec2909fbca8d1036fe409d33af9b.c8c30e936bffb9f93bcba2c27682dcca1ab79aced6d1cf015a11d56a9c2f9f5.c49d8757a19b693d78d1772977cbf164e2748b57bb9f.ud.msft[.]center） 4.使用模仿的域名
## 活动FinSupport
特征：
1.底层隧道工具Cobalt Strike,Cobalt Strike的代表性特征包括使用WWW、POST、和API等常见前缀(例如：api.12abc2cb5.446f35fa.dns.cloud-enrollment[.]com)

## 活动Decoy Dog
1.底层隧道工具Pupy,该工具在编码数据时使用字符9作为填充。(例如：fstz1yibfqnaw6mxpen3nknghh2q9999.1112umplhvbbzf2udr2rpuq9.claudfront[.]net)
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/c5a42b8a-aef0-4873-9df3-e1ccd74b84d0)


# DNS隧道用来进行VPN服务
为了规避企业环境中的审查措施，员工使用了利用DNS隧道技术的虚拟专用网络VPN服务。
这种类型的VPN服务与用于恶意C2通信的DNS隧道具有相同的特征。这些特性包括用于通信的通用名称服务器，或用于编码和解码的通用隧道工具。
## Astrill VPN
1.隧道传输使用IPV6（AAAA）请求和响应 2.使用49个隧道域的语料库来避免被阻止，包括.com、.net、.pw、.tech、.top、.space
（例如简单的Record：0g87sbvrbb8f79ee.s2bbv747ck53wp7k.s.nanogardens[.]tech AAAA 1327:fb85:793c:bda6:d571:841f:b240[:]1cb2)
## HA Tunnel Plus
1.使用TXT请求和响应 2.为了优化其性能HA tunnel Plus使用多个名称服务器来服务来自不同区域的隧道流量
（例如简单的Record:t3f43builrjoxy5olfgijiryoi3vcabaabtq4byag2cqaad3emaaa3aaaaacsnn.5rhm62glydte5esgax5p57dwyygwfnszyvpc4s2euahvqeceqb6crq64lbq5fr6.4lwcok3fmou2bobxyv2v27u67oez35kt5suc7eek26ykoob32vizswowherp2vj.bv2cnzu3luktz7aplh2whj63kmd2tb5kse4rky3ag4r.ns-ca1.hat53[.]com TXT \\000\\024\\1628r7r\\000@\\000\\140\\014\\007\\0009\\133\\000\\000u\\133\\000\\000\\000\\000\\000\\000）
## dnstt是多种VPN服务使用的开源DNS隧道工具
MinaProNet VPN
Edoztunnel VPN
TunnelCat VPN
Dnstt专门使用TXT记录将数据编码到DNS响应中。除了标志的UDP之外，dnstt还可以使用DOH（DNS-over-HTTPS）和DOT（DNS-over-TLS）来逃避检查
# DNS隧道用来安全监控
网络安全供应商可以利用DNS流量的宽松策略，并使用DNS隧道利用DNS流量的宽松策略，并使用DNS隧道技术来构建易于部署的通信通道。我们可以使用这些通信信道对文件和域进行实时检查，以及监视驻留在内部网络中的蜜罐。
# DNS隧道新技术--利用DNS隧道技术跟踪和扫描
1.TrkCdn活动--追踪受害者与钓鱼电子邮件内容的关联
不同目标的FQDN -->(转发到)cdn.simitor[.]com使用相同IP地址-->(权威域名服务器返回一个DNS结果，指向一个由攻击者控制的服务器)-->服务器发送由攻击者控制的内容。
2.SpamTracker--跟踪垃圾邮件内容的发送
3.SecShow活动--利用DNS隧道扫描网络基础设施。
在DNS查询中嵌入IP地址和时间戳
# DNS隧道检测 -- 机器学习
DNS隧道检测使用机器学习分析DNS查询、DNS响应的行为指令以及域的托管方式。
# DNS隧道检测 -- 提取特征
关键思想是从隧道domain中提取不同工具和活动的独特特性：
1.隧道domain的托管方式
2.数据如何编码为查询和响应
3.数据的传输方式和时间
4.辅助信息，例如谁是目标以及有关这些域的第三方裁决
标记数据集，包含50多个隧道工具和活动以及1000多个隧道domain。系统使用上述特征将新检测到的隧道domain与标记的隧道进行比较，以自动预测新遇到的域是否属于现有活动或使用已知的隧道工具。










































