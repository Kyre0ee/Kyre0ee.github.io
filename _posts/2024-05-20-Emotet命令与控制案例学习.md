---
layout: post
title: Emotet命令与控制案例学习
date: 2024-05-20 09:30
tags: C2
toc: true
---
相关链接：https://unit42.paloaltonetworks.com/emotet-command-and-control/
更新版本与不同的命令和控制（C2）服务器进行通信，攻击者利用复杂的规避技术和加密算法与C2服务器进行通信，以探测受害者的网络环境和进程，从而窃取敏感信息或丢弃新的有效负载。
逐步分析
1.主要逻辑
(1)入口C2_logic_ep(sub_2E2C63)
(2)使用了两个加密函数：encryption_functions_one和encryption_functions_two这两个函数都使用了Microsoft's的基本密码学接口（CryptoAPI）
(3)generate_machine_id为被攻击的计算机生成机器标识符，调用_snprintf函数，调用格式字符串%s_%08X连接GetComputerNameA和GetVolumeInformationW生成的值。
(4)gen_machine_id_length对于生成的机器ID进程长度校验。结果长度为12将该值驻留在特定的堆栈中用作C2数据的一部分。
(5)collect_os_data操作系统数据收集
(6)远程桌面服务会话信息收集调用GetCurrentProcessID(检索当前进程的进程标识符，并返回值作为参数传递给ProcessIDToSessionID)。根据MSDN描述，ProcessIdToSessionid函数检索与指定进程关联的远程桌面服务会话。该函数的返回值指示当前进程正在运行的终端服务会话。
(7)过程扫描和C2数据收集
(8)调用HTTP_LAUNCHER
(9)调用c2_data_write函数，调用write_collected_data子函数并传递参数(1.指向C2数据的指针，)
(10)copy_c2_data，该函数将C2数据复制到新位置。
2.C2数据通过HTTP协议泄露到C2服务器
