---
layout: post
title: Emotet命令与控制案例-代码侧分析
date: 2024-05-20 09:30
tags: C2
excerpt: "Emotet一个样本的分析记录。"
toc: true
---

> 相关链接：https://unit42.paloaltonetworks.com/emotet-command-and-control/

更新版本与不同的命令和控制（C2）服务器进行通信，攻击者利用复杂的规避技术和加密算法与C2服务器进行通信，以探测受害者的网络环境和进程，从而窃取敏感信息或丢弃新的有效负载。  

## 逐步分析  

### 1.主要逻辑
(1)入口C2_logic_ep(sub_2E2C63)
(2)使用了两个加密函数：encryption_functions_one和encryption_functions_two这两个函数都使用了Microsoft's的基本密码学接口（CryptoAPI）
(3)generate_machine_id为被攻击的计算机生成机器标识符，调用_snprintf函数，调用格式字符串%s_%08X连接GetComputerNameA和GetVolumeInformationW生成的值。
(4)gen_machine_id_length对于生成的机器ID进程长度校验。结果长度为12将该值驻留在特定的堆栈中用作C2数据的一部分。
(5)collect_os_data操作系统数据收集
(6)远程桌面服务会话信息收集调用GetCurrentProcessID(检索当前进程的进程标识符，并返回值作为参数传递给ProcessIDToSessionID)。根据MSDN描述，ProcessIdToSessionid函数检索与指定进程关联的远程桌面服务会话。该函数的返回值指示当前进程正在运行的终端服务会话。
(7)过程扫描和C2数据收集
(8)调用HTTP_LAUNCHER
(9)调用c2_data_write函数，调用write_collected_data子函数并传递参数(1.指向C2数据的指针，)
(10)收集数据后，将调用 write_c2_data_zero，它将通过调用 AllocateHeap (0x2E99DC) 函数分配额外的内存。
(11)copy_c2_data，该函数将C2数据复制到新位置。
(11)调用CryptDuplicateHash，此时缓冲区的数据格式如下
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/ee500b92-89b5-4f84-a47a-a5497c13de2f)

(13)CryptEncrypt 它将通过间接调用位于偏移量 0x2F0AD4 处的 EAX 寄存器来到达真正的 API 函数。
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/115ecffc-fbd3-4fdb-8363-c0804272f0fb)

(14)C2 数据加密后，下一步是通过调用偏移量 0x2EFF2C 处的 CryptExportKey 函数导出当前加密密钥。
(15)导出密钥后，位于偏移量 0x2EFF41 处的循环在偏移量 0x2EFF43 处有一条指令，该指令将导出密钥的 0x60 字节写入 C2 数据。
(16)使用一个参数调用 API 函数 CryptGetHashParam，该参数包含指向 CryptDestroyHash 的指针，该指针会将生成的哈希值的 20 个字节写入 C2 数据中。
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/aa74ad29-2c6e-4585-83da-b668175efe52)
至此，包含导处密钥、哈希值和加密C2数据的C2数据完成。
### 2.C2数据通过HTTP协议泄露到C2服务器
到达数据传输阶段。
(1)准备所需的数据：如IP 地址、HTTP 表单结构和值
(2)执行 copy_c2_data 子函数来实现的。 此函数将生成“application/octet-stream”内容类型的二进制 MIME 附件，其中输入数据适合二进制传输。
(3)从函数调用列表中可以看出，HttpSendRequestW() API函数用于将数据发送到服务器。 此功能允许发送方超出 HTTP 客户端通常发送的数据量。
![image](https://github.com/kyre0e/kyre0e.github.io/assets/169347540/eb99b8f8-208c-4eeb-838a-6c17439e8a5c)
