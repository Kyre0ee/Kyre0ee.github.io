---
layout: post
title: 使用QEMU搭建自动化沙箱工具
date: 2023-12-23 09:30
tags: Malware防御
excerpt: "如何使用QEMU和Suricata搭建一个自动化沙箱工具，支持Windows x86、Windows x64和Ubuntu虚拟机，自动运行可执行文件并生成IOC（Indicators of Compromise）和规则匹配日志。"
toc: true
---
# 使用QEMU搭建自动化沙箱工具

## 步骤1：安装和配置QEMU、suricata

在Ubuntu系统上：

1. **更新系统**：
    ```bash
    sudo apt update
    sudo apt upgrade
    ```

2. **安装QEMU和相关工具**：
    ```bash
    sudo apt install qemu qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager suricata python3-pip
    ```

3. **启用并启动libvirtd服务**：
    ```bash
    sudo systemctl enable libvirtd
    sudo systemctl start libvirtd
    ```

4. **将用户添加到libvirt和kvm组**：
    ```bash
    sudo usermod -aG libvirt $USER
    sudo usermod -aG kvm $USER
    newgrp libvirt
    newgrp kvm
    ```
   然后注销并重新登录。

## 步骤2：创建虚拟机镜像

1. **下载ISO镜像**：
   - Windows x86和x64镜像可从微软官方渠道下载。
   - Ubuntu镜像下载：
   ```bash
    wget https://releases.ubuntu.com/22.04/ubuntu-22.04-live-server-amd64.iso
    ```

3. **创建虚拟硬盘**：
    ```bash
    qemu-img create -f qcow2 win-x86.qcow2 30G
    qemu-img create -f qcow2 win-x64.qcow2 30G
    qemu-img create -f qcow2 ubuntu.qcow2 20G
    ```

4. **安装操作系统**：
    ```bash
    sudo qemu-system-x86_64 -hda win-x86.qcow2 -cdrom /path/to/windows-x86.iso -boot d -m 2048 -smp 2
    sudo qemu-system-x86_64 -hda win-x64.qcow2 -cdrom /path/to/windows-x64.iso -boot d -m 2048 -smp 2
    sudo qemu-system-x86_64 -hda ubuntu.qcow2 -cdrom ubuntu-22.04-live-server-amd64.iso -boot d -m 2048 -smp 2
    ```
    
## 步骤3：配置虚拟机和网络

1. **配置网络**

编辑网络配置文件，启用桥接网络或用户网络（用户网络无需额外配置）：
```bash
sudo nano /etc/qemu/bridge.conf
```
添加以下内容
```bash
allow all
```
## 步骤4：设置自动化控制

要实现自动化控制，可以使用以下工具和技术：

1. **Python脚本和QEMU Monitor**：
   QEMU Monitor提供了一个控制台，可以通过命令控制虚拟机。可以使用Python脚本和QEMU Monitor的QMP（QEMU Machine Protocol）进行自动化控制。

   安装`qmpy`库：
    ```bash
    pip install qmpy
    ```

   示例Python脚本：
    ```python
    from qmpy import QMP

    def run_command(command):
        qmp = QMP()
        qmp.connect("/var/run/qemu-server/100.qmp")
        result = qmp.command(command)
        qmp.disconnect()
        return result

    # 启动虚拟机
    run_command({"execute": "system_powerdown"})
    ```

2. **使用QEMU's `-monitor` 选项**：
   在启动QEMU时，使用`-monitor`选项指定一个socket文件，以便后续通过该socket进行控制。
    ```bash
    qemu-system-x86_64 -hda ubuntu-vm.qcow2 -m 2048 -monitor unix:/tmp/qemu-monitor-socket,server,nowait
    ```

## 步骤4：捕获和分析沙箱中的行为

1. **网络流量捕获**：
   使用`tcpdump`或`wireshark`在主机上捕获虚拟机的网络流量：
    ```bash
    sudo tcpdump -i virbr0 -w vm-traffic.pcap
    ```

2. **文件和进程监控**：
   在虚拟机内部使用工具（如`auditd`、`strace`、`inotify`等）监控文件和进程活动。例如，安装`auditd`：
    ```bash
    sudo apt install auditd
    sudo service auditd start
    ```

   配置审计规则，监控关键文件和目录：
    ```bash
    sudo auditctl -w /etc/passwd -p wa -k passwd_changes
    ```

3. **日志收集和分析**：
   使用ELK Stack（Elasticsearch, Logstash, Kibana）或Splunk等日志分析工具，集中收集和分析虚拟机生成的日志。

## 步骤5：自动化分析和报告生成

1. **自动化脚本**：
   编写Python脚本，自动执行以下任务：
   - 启动虚拟机
   - 部署和运行恶意软件样本
   - 监控和捕获行为
   - 停止和销毁虚拟机
   - 收集和分析数据

2. **生成报告**：
   使用Python或其他脚本语言，解析监控和捕获的数据，生成可视化报告。例如，使用`matplotlib`生成图表：
    ```python
    import matplotlib.pyplot as plt

    def generate_report(data):
        plt.plot(data['time'], data['events'])
        plt.title("Malware Behavior Analysis")
        plt.xlabel("Time")
        plt.ylabel("Events")
        plt.savefig("report.png")
    ```

## 示例自动化脚本

以下是一个简化的示例脚本，演示如何启动虚拟机、运行恶意软件、捕获行为并生成报告：

```python
import subprocess
import time
import json
from qmpy import QMP

def start_vm(image, name, monitor_socket):
    subprocess.Popen([
        "qemu-system-x86_64",
        "-name", name,
        "-hda", image,
        "-m", "2048",
        "-net", "nic",
        "-net", "user",
        "-monitor", f"unix:{monitor_socket},server,nowait"
    ])

def run_malware(vm_name, exec_path):
    # 假设恶意软件已经预先放置在虚拟机中
    qmp = QMP()
    qmp.connect(f"/tmp/{vm_name}-monitor-socket")
    qmp.command({"execute": "guest-exec", "arguments": {"path": exec_path}})
    qmp.disconnect()

def capture_traffic():
    subprocess.Popen([
        "tcpdump", "-i", "virbr0", "-w", "/tmp/vm-traffic.pcap"
    ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)

def run_suricata(pcap_file):
    subprocess.run([
        "suricata", "-r", pcap_file, "-l", "/var/log/suricata"
    ])

def parse_suricata_logs(log_file):
    iocs = {"ips": set(), "domains": set(), "files": set()}
    with open(log_file, 'r') as f:
        for line in f:
            log_entry = json.loads(line)
            if 'alert' in log_entry:
                if 'src_ip' in log_entry:
                    iocs['ips'].add(log_entry['src_ip'])
                if 'http' in log_entry and 'hostname' in log_entry['http']:
                    iocs['domains'].add(log_entry['http']['hostname'])
                if 'fileinfo' in log_entry:
                    iocs['files'].add(log_entry['fileinfo']['filename'])
    return iocs

def generate_ioc_report(iocs, output_file):
    with open(output_file, 'w') as f:
        f.write("# Indicators of Compromise (IOC) Report\n")
        f.write("## IPs:\n")
        for ip in iocs['ips']:
            f.write(f"- {ip}\n")
        f.write("## Domains:\n")
        for domain in iocs['domains']:
            f.write(f"- {domain}\n")
        f.write("## Files:\n")
        for file in iocs['files']:
            f.write(f"- {file}\n")

def main():
    vms = [
        {"image": "win-x86.qcow2", "name": "win-x86", "exec_path": "C:\\path\\to\\malware.exe"},
        {"image": "win-x64.qcow2", "name": "win-x64", "exec_path": "C:\\path\\to\\malware.exe"},
        {"image": "ubuntu.qcow2", "name": "ubuntu", "exec_path": "/home/user/malware"}
    ]

    for vm in vms:
        start_vm(vm['image'], vm['name'], f"/tmp/{vm['name']}-monitor-socket")
        time.sleep(30)  # 等待虚拟机启动
        run_malware(vm['name'], vm['exec_path'])
        time.sleep(60)  # 运行恶意软件

    capture_traffic()
    time.sleep(60)  # 捕获流量

    run_suricata("/tmp/vm-traffic.pcap")
    iocs = parse_suricata_logs("/var/log/suricata/eve.json")
    generate_ioc_report(iocs, "ioc_report.md")

if __name__ == "__main__":
    main()
```
