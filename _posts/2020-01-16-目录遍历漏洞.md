---
layout: post
title: 目录遍历漏洞
date: 2020-01-16 09:30
tags: web安全
excerpt: "本文介绍web安全漏洞-目录遍历漏洞。"
toc: true
---	
# 目录遍历漏洞

## 什么是目录遍历漏洞

目录遍历漏洞（Directory Traversal）是一种Web安全漏洞，攻击者通过该漏洞可以访问服务器上的任意文件，绕过应用程序的访问控制。攻击者通常利用特殊字符序列（如 `../`）来遍历文件系统，从而读取敏感文件，如配置文件、密码文件等。

## 目录遍历漏洞的技术细节

目录遍历漏洞的成因主要包括：

- **输入验证不足**：对用户输入的文件路径没有进行严格的验证和过滤。
- **不安全的文件操作**：直接使用用户输入的文件路径进行文件操作。
- **不当的权限配置**：服务器文件系统的权限配置不当，允许访问敏感文件。

## 目录遍历漏洞案例

### 案例背景

某Web应用允许用户查看日志文件。用户通过提供文件名来指定要查看的日志文件。然而，该应用在处理文件名时，没有对用户输入进行充分的验证，导致目录遍历漏洞。

### 漏洞利用

攻击者可以通过构造恶意的文件路径，访问服务器上的任意文件。例如，攻击者可以输入以下路径来访问系统的密码文件：

```
../../../../etc/passwd
```

应用程序处理文件名的代码如下：

``` python
# vulnerable_code.py
import os

def read_log_file(filename):
    log_dir = "/var/log/myapp/"
    file_path = os.path.join(log_dir, filename)
    with open(file_path, 'r') as file:
        return file.read()

# 假设用户输入的文件名为filename
filename = "../../../../../etc/passwd"
content = read_log_file(filename)
print(content)
```

由于没有对 filename 进行验证，攻击者构造的路径会直接传递给 os.path.join 函数，从而读取 /etc/passwd 文件的内容。

## 防御手段
### 防御目录遍历漏洞的方法包括：

- 输入验证：对用户输入的文件路径进行严格的验证和过滤，确保只能访问允许的目录。
- 限制文件访问范围：使用安全的文件操作函数，限制文件访问范围到特定目录。
- 避免直接使用用户输入：避免直接使用用户输入的文件路径，使用安全的映射机制将用户输入转换为安全的文件路径。
- 权限配置：确保服务器文件系统的权限配置正确，限制对敏感文件的访问。

### 代码示例

不安全的代码示例

```
# vulnerable_code.py
import os

def read_log_file(filename):
    log_dir = "/var/log/myapp/"
    file_path = os.path.join(log_dir, filename)
    with open(file_path, 'r') as file:
        return file.read()

# 假设用户输入的文件名为filename
filename = "../../../../../etc/passwd"
content = read_log_file(filename)
print(content)

```

安全的代码示例

```
# safe_code.py
import os

def read_log_file(filename):
    log_dir = "/var/log/myapp/"
    # 仅允许访问log_dir目录下的文件
    file_path = os.path.join(log_dir, filename)
    # 检查文件路径是否在log_dir目录下
    if not os.path.commonpath([log_dir]) == os.path.commonpath([log_dir, file_path]):
        raise ValueError("非法文件路径")
    with open(file_path, 'r') as file:
        return file.read()

# 假设用户输入的文件名为filename
filename = "access.log"
try:
    content = read_log_file(filename)
    print(content)
except ValueError as e:
    print(e)
```

在安全的代码示例中，使用了 os.path.commonpath 函数来验证文件路径是否在允许的目录下，防止目录遍历攻击。

## 总结

目录遍历漏洞是一种常见且严重的Web安全漏洞，攻击者可以通过该漏洞访问服务器上的任意文件。防御目录遍历漏洞的关键在于严格的输入验证、限制文件访问范围、避免直接使用用户输入的文件路径，以及正确配置服务器文件系统的权限。通过这些措施，可以有效地减少目录遍历漏洞的风险。
