## suricata源码分析记录

### 实验环境

/etc/suricata/rules/suricata.rules

实验用规则：

alert tcp any any -> any any (msg:"APP-DETECT Splashtop outbound connection attempt"; content:"baidu";http_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.wikipedia.org/wiki/Splashtop; classtype:policy-violation; sid:27922; rev:2;)

alert tcp any any -> any any (msg:"TESTING BY ROCKL"; content:"rockl";http_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.wikipedia.org/wiki/Splashtop; classtype:policy-violation; sid:27923; rev:2;)

### 规则加载逻辑

sudo **tail** -f /var/log/suricata/fast.log

sudo suricata -c /etc/suricata/suricata.yaml -i ens33

实验用命令：

sudo wget [http://192.168.126.154/baidu](http://192.168.126.154/baidu)

sudo wget [http://192.168.126.154/rockl](http://192.168.126.154/rockl)

### 规则解析流程

SigInitHelper (de_ctx=de_ctx@entry=0x555556c1d2c0,                                                                                                 

    sigstr=sigstr@entry=0x7fffffffb370 "alert tcp any any -> any any (msg:\"APP-DETECT Splashtop outbound connection attempt\"; content:\"baidu\";ht

tp_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.w"..., dir=dir@entry=0x0) at detect-parse.c:1865    

1865        int ret = SigParse(de_ctx, sig, sigstr, dir, &parser);                                                                                 

gdb-peda$ bt                                                                                                                                        

#0  SigInitHelper (de_ctx=de_ctx@entry=0x555556c1d2c0,                                                                                             

    sigstr=sigstr@entry=0x7fffffffb370 "alert tcp any any -> any any (msg:\"APP-DETECT Splashtop outbound connection attempt\"; content:\"baidu\";ht

tp_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.w"..., dir=dir@entry=0x0) at detect-parse.c:1865    

#1  0x00005555556787a8 in SigInit (de_ctx=de_ctx@entry=0x555556c1d2c0,                                                                             

    sigstr=sigstr@entry=0x7fffffffb370 "alert tcp any any -> any any (msg:\"APP-DETECT Splashtop outbound connection attempt\"; content:\"baidu\";ht

tp_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.w"...) at detect-parse.c:2017                       

#2  0x0000555555678a2d in DetectEngineAppendSig (de_ctx=de_ctx@entry=0x555556c1d2c0,                                                                

    sigstr=sigstr@entry=0x7fffffffb370 "alert tcp any any -> any any (msg:\"APP-DETECT Splashtop outbound connection attempt\"; content:\"baidu\";ht

tp_uri; fast_pattern:only; metadata:policy max-detect-ips drop, service http; reference:url,en.w"...) at detect-parse.c:2303                       

#3  0x000055555563a5d6 in DetectLoadSigFile (badsigs=0x7fffffffd3ec, goodsigs=0x7fffffffd3e8,                                                      

    sig_file=0x555556c7b590 "/etc/suricata/rules/suricata.rules", de_ctx=0x555556c1d2c0) at detect-engine-loader.c:169                             

#4  ProcessSigFiles (de_ctx=de_ctx@entry=0x555556c1d2c0, pattern=pattern@entry=0x555556c69f60 "/etc/suricata/rules/suricata.rules",                 

    st=st@entry=0x555556c1e6f8, good_sigs=good_sigs@entry=0x7fffffffd3e8, bad_sigs=bad_sigs@entry=0x7fffffffd3ec) at detect-engine-loader.c:250    

#5  0x000055555563be3c in SigLoadSignatures (de_ctx=0x555556c1d2c0, sig_file=0x0, sig_file_exclusive=) at detect-engine-loader.c:310

#6  0x0000555555582425 in LoadSignatures (suri=0x555555c8ac80 , suri=0x555555c8ac80 , de_ctx=0x555556c1d2c0) at suricata.c:2486

#7  PostConfLoadedDetectSetup (suri=0x555555c8ac80 ) at suricata.c:2640                                                                   

#8  main (argc=argc@entry=0x5, argv=argv@entry=0x7fffffffe668) at suricata.c:3065                                                                  

#9  0x00007ffff6101b97 in __libc_start_main (main=0x555555580280 , argc=0x5, argv=0x7fffffffe668, init=,                      

    fini=, rtld_fini=, stack_end=0x7fffffffe658) at ../csu/libc-start.c:310                                          

#10 0x00005555555832ea in _start ()    

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)

检测逻辑：

#0  DetectRun (th_v=th_v@entry=0x555556c7f260, de_ctx=0x555556c1d2c0, det_ctx=0x7ffff03727c0, p=p@entry=0x7ffff0268180) at detect.c:117            

#1  0x00005555556070f8 in DetectRun (p=0x7ffff0268180, det_ctx=, de_ctx=, th_v=0x555556c7f260) at detect.c:1583      

#2  DetectNoFlow (p=, det_ctx=, de_ctx=, tv=) at detect.c:1590                         

#3  Detect (tv=tv@entry=0x555556c7f260, p=p@entry=0x7ffff0268180, data=data@entry=0x7ffff03727c0, pq=pq@entry=0x0, postpq=postpq@entry=0x0)        

    at detect.c:1650                                                                                                                                

#4  0x00005555556a5604 in FlowWorker (tv=0x555556c7f260, p=0x7ffff0268180, data=0x7ffff02901b0, preq=0x555556c80900, unused=)       

    at flow-worker.c:289                                                                                                                           

#5  0x000055555572b3ab in TmThreadsSlotVarRun (tv=tv@entry=0x555556c7f260, p=p@entry=0x7ffff0268180, slot=slot@entry=0x555556c80780)               

    at tm-threads.c:134                                                                                                                            

#6  0x00005555557029a6 in TmThreadsSlotProcessPkt (p=0x7ffff0268180, s=0x555556c80780, tv=0x555556c7f260) at tm-threads.h:163                      

#7  AFPReadFromRing (ptv=) at source-af-packet.c:1025                                                                               

#8  0x000055555570678e in ReceiveAFPLoop (tv=0x555556c7f260, data=, slot=) at source-af-packet.c:1589                

#9  0x000055555572f5a1 in TmThreadsSlotPktAcqLoop (td=0x555556c7f260) at tm-threads.c:360                                                          

#10 0x00007ffff6d9d6db in start_thread (arg=0x7ffff5518700) at pthread_create.c:463                                                                

#11 0x00007ffff620188f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95 

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg) 

### 基于协议的检测逻辑：

gdb-peda$ bt                                                                                                                                       

#0  DetectProtoContainsProto (dp=dp@entry=0x555556c7cda2, proto=0x6) at detect-engine-proto.c:137                                                  

#1  0x0000555555606ac7 in DetectRunInspectRuleHeader (s_proto_flags=, sflags=0x98040f, s=0x555556c7cd90, f=,         

    p=0x7ffff0268180) at detect.c:607                                                                                                               

#2  DetectRulePacketRules (de_ctx=0x555556c1d2c0, scratch=0x7ffff5516870, scratch=0x7ffff5516870, pflow=, p=0x7ffff0268180,         

    det_ctx=0x7ffff03727c0, tv=0x555556c7f260) at detect.c:792                                                                                     

#3  DetectRun (th_v=th_v@entry=0x555556c7f260, de_ctx=0x555556c1d2c0, det_ctx=0x7ffff03727c0, p=p@entry=0x7ffff0268180) at detect.c:130            

#4  0x00005555556070f8 in DetectRun (p=0x7ffff0268180, det_ctx=, de_ctx=, th_v=0x555556c7f260) at detect.c:1583      

#5  DetectNoFlow (p=, det_ctx=, de_ctx=, tv=) at detect.c:1590                         

#6  Detect (tv=tv@entry=0x555556c7f260, p=p@entry=0x7ffff0268180, data=data@entry=0x7ffff03727c0, pq=pq@entry=0x0, postpq=postpq@entry=0x0)        

    at detect.c:1650                                                                                                                               

#7  0x00005555556a5604 in FlowWorker (tv=0x555556c7f260, p=0x7ffff0268180, data=0x7ffff02901b0, preq=0x555556c80900, unused=)       

    at flow-worker.c:289                                                                                                                            

#8  0x000055555572b3ab in TmThreadsSlotVarRun (tv=tv@entry=0x555556c7f260, p=p@entry=0x7ffff0268180, slot=slot@entry=0x555556c80780)               

    at tm-threads.c:134                                                                                                                             

#9  0x00005555557029a6 in TmThreadsSlotProcessPkt (p=0x7ffff0268180, s=0x555556c80780, tv=0x555556c7f260) at tm-threads.h:163                      

#10 AFPReadFromRing (ptv=) at source-af-packet.c:1025                                                                                

#11 0x000055555570678e in ReceiveAFPLoop (tv=0x555556c7f260, data=, slot=) at source-af-packet.c:1589                

#12 0x000055555572f5a1 in TmThreadsSlotPktAcqLoop (td=0x555556c7f260) at tm-threads.c:360                                                          

#13 0x00007ffff6d9d6db in start_thread (arg=0x7ffff5518700) at pthread_create.c:463                                                                

#14 0x00007ffff620188f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95     

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image006.jpg) 

enum AppProtoEnum {

    ALPROTO_UNKNOWN = 0,

    ALPROTO_HTTP,

    ALPROTO_FTP,

    ALPROTO_SMTP,

    ALPROTO_TLS, /* SSLv2, SSLv3 & TLSv1 */

    ALPROTO_SSH,

    ALPROTO_IMAP,

    ALPROTO_JABBER,

    ALPROTO_SMB,

    ALPROTO_DCERPC,

    ALPROTO_IRC,

    ALPROTO_DNS,

    ALPROTO_MODBUS,

    ALPROTO_ENIP,

    ALPROTO_DNP3,

    ALPROTO_NFS,

    ALPROTO_NTP,

    ALPROTO_FTPDATA,

    ALPROTO_TFTP,

    ALPROTO_IKEV2,

    ALPROTO_KRB5,

    ALPROTO_DHCP,

    ALPROTO_SNMP,

    ALPROTO_SIP,

    ALPROTO_TEMPLATE,

    ALPROTO_TEMPLATE_RUST,

    ALPROTO_RDP,

    /* used by the probing parser when alproto detection fails

     * permanently for that particular stream */

    ALPROTO_FAILED,

#ifdef UNITTESTS

    ALPROTO_TEST,

#endif /* UNITESTS */

    /* keep last */

    ALPROTO_MAX,

};

协议的枚举列表。

gdb-peda$ i b                                                                                                                                      

Num     Type           Disp Enb Address            What                                                                                             

14      breakpoint     keep y   0x0000555555660fe0 in DetectHttpHostValidateCallback at detect-http-host.c:169                                     

15      breakpoint     keep y   0x0000555555660f20 in DetectHttpHostRawSetupSticky at detect-http-host.c:274                                       

16      breakpoint     keep y   0x0000555555660fc0 in DetectHttpHHSetup at detect-http-host.c:162                                                  

17      breakpoint     keep y   0x0000555555661dd0 in DetectHttpProtocolRegister at detect-http-protocol.c:123                                     

        breakpoint already hit 1 time                                                                                                               

18      breakpoint     keep y   0x0000555555661d90 in DetectHttpProtocolSetup at detect-http-protocol.c:76                                         

19      breakpoint     keep y   0x0000555555664370 in DetectHttpUriValidateCallback at detect-http-uri.c:183                                       

        breakpoint already hit 2 times                                                                                                             

20      breakpoint     keep y   0x00005555556644e0 in GetData at detect-http-uri.c:212                                                             

        breakpoint already hit 4 times                                                                                                              

21      breakpoint     keep y   0x0000555555664360 in DetectHttpRawUriValidateCallback at detect-http-uri.c:257                                    

22      breakpoint     keep y   0x00005555556643a0 in GetRawData at detect-http-uri.c:286                                                           

23      breakpoint     keep y   0x00005555555c8600 in RegisterHTPParsers at app-layer-htp.c:3164    、

保存当前http 匹配逻辑的栈。

当一个http包过来的时候 协议部分的处理逻辑：

gdb-peda$ bt                                                                                                                                       

#0  AppLayerHandleTCPData (tv=tv@entry=0x555556c1ea80, ra_ctx=ra_ctx@entry=0x7ffff02a1670, p=p@entry=0x7ffff0268180, f=0x555556880510,             

    ssn=ssn@entry=0x7ffff03726a0, stream=stream@entry=0x7ffff5516768,                                                                              

    data=0x7ffff04b5a50 "GET /baidu HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost: 192.168.126

.154\r\nConnection: Keep-Alive\r\n\r\n", data_len=0x93, flags=0x5) at app-layer.c:573                                                               

#1  0x00005555557205aa in ReassembleUpdateAppLayer (dir=, p=, stream=, ssn=,           

    ra_ctx=, tv=) at stream-tcp-reassemble.c:1083                                                                    

#2  StreamTcpReassembleAppLayer (tv=tv@entry=0x555556c1ea80, ra_ctx=ra_ctx@entry=0x7ffff02a1670, ssn=ssn@entry=0x7ffff03726a0,                     

    stream=, stream@entry=0x7ffff0372730, p=p@entry=0x7ffff0268180, dir=dir@entry=UPDATE_DIR_OPPOSING)                               

    at stream-tcp-reassemble.c:1140                                                                                                                

#3  0x0000555555721315 in StreamTcpReassembleHandleSegmentUpdateACK (p=0x7ffff0268180, stream=0x7ffff0372730, ssn=0x7ffff03726a0,                  

    ra_ctx=0x7ffff02a1670, tv=0x555556c1ea80) at stream-tcp-reassemble.c:1714                                                                      

#4  StreamTcpReassembleHandleSegment (tv=tv@entry=0x555556c1ea80, ra_ctx=0x7ffff02a1670, ssn=ssn@entry=0x7ffff03726a0, stream=0x7ffff03726b0,      

    p=p@entry=0x7ffff0268180, pq=pq@entry=0x7ffff02a1318) at stream-tcp-reassemble.c:1757                                                          

#5  0x0000555555716090 in HandleEstablishedPacketToClient (stt=, pq=, p=, ssn=,        

    tv=) at stream-tcp.c:2445                                                                                                       

#6  StreamTcpPacketStateEstablished (tv=0x555556c1ea80, p=0x7ffff0268180, stt=stt@entry=0x7ffff02a1310, ssn=0x7ffff03726a0, pq=0x7ffff02a1318)     

    at stream-tcp.c:2682                                                                                                                           

#7  0x0000555555719e00 in StreamTcpStateDispatch (tv=0x555556c1ea80, p=0x7ffff0268180, stt=0x7ffff02a1310, ssn=0x7ffff03726a0, pq=0x7ffff02a1318,  

    state=) at stream-tcp.c:4687                                                                                                     

#8  0x000055555571bef3 in StreamTcpPacket (tv=0x555556c1ea80, p=0x7ffff0268180, stt=0x7ffff02a1310, pq=0x7ffff02901d8) at stream-tcp.c:4876        

#9  0x000055555571ca64 in StreamTcp (tv=tv@entry=0x555556c1ea80, p=p@entry=0x7ffff0268180, data=, pq=pq@entry=0x7ffff02901d8,       

    postpq=postpq@entry=0x0) at stream-tcp.c:5212                                                                                                  

#10 0x00005555556a5581 in FlowWorker (tv=0x555556c1ea80, p=0x7ffff0268180, data=0x7ffff02901b0, preq=0x555556c1f470, unused=)       

    at flow-worker.c:245                                                                                                                           

#11 0x000055555572b3ab in TmThreadsSlotVarRun (tv=tv@entry=0x555556c1ea80, p=p@entry=0x7ffff0268180, slot=slot@entry=0x555556c1f2f0)               

    at tm-threads.c:134                                                                                                                             

#12 0x00005555557029a6 in TmThreadsSlotProcessPkt (p=0x7ffff0268180, s=0x555556c1f2f0, tv=0x555556c1ea80) at tm-threads.h:163                      

#13 AFPReadFromRing (ptv=) at source-af-packet.c:1025                                                                                

#14 0x000055555570678e in ReceiveAFPLoop (tv=0x555556c1ea80, data=, slot=) at source-af-packet.c:1589                

#15 0x000055555572f5a1 in TmThreadsSlotPktAcqLoop (td=0x555556c1ea80) at tm-threads.c:360                                                           

#16 0x00007ffff6d9d6db in start_thread (arg=0x7ffff5518700) at pthread_create.c:463                                                                

#17 0x00007ffff620188f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95      

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image008.jpg)

协议解析流程：

Legend: code, data, rodata, value                                                                                                                  

Thread 2 "W#01-ens33" hit Breakpoint 31, HTPHandleRequestData (f=0x5555568929c0, htp_state=0x7ffff04bca70, pstate=0x7ffff04c9550,                  

    input=0x7ffff04ba2c0 "GET /rockl HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost: 192.168.12

6.154\r\nConnection: Keep-Alive\r\n\r\n", input_len=0x93, local_data=0x0, flags=0x5) at app-layer-htp.c:848                                        

848     {                                                                                                                                           

gdb-peda$ bt                                                                                                                                        

#0  HTPHandleRequestData (f=0x5555568929c0, htp_state=0x7ffff04bca70, pstate=0x7ffff04c9550,                                                       

    input=0x7ffff04ba2c0 "GET /rockl HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost: 192.168.12

6.154\r\nConnection: Keep-Alive\r\n\r\n", input_len=0x93, local_data=0x0, flags=0x5) at app-layer-htp.c:848                                        

#1  0x00005555555cfd18 in AppLayerParserParse (tv=tv@entry=0x555556c1ea80, alp_tctx=0x7ffff02a1a90, f=f@entry=0x5555568929c0, alproto=0x1,         

    flags=flags@entry=0x5,                                                                                                                          

    input=input@entry=0x7ffff04ba2c0 "GET /rockl HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost

: 192.168.126.154\r\nConnection: Keep-Alive\r\n\r\n", input_len=0x93) at app-layer-parser.c:1239                                                    

#2  0x000055555558a2a6 in TCPProtoDetect (tv=tv@entry=0x555556c1ea80, ra_ctx=, app_tctx=app_tctx@entry=0x7ffff02a16a0,              

    p=p@entry=0x7ffff0268180, f=f@entry=0x5555568929c0, ssn=ssn@entry=0x7ffff0371f20, stream=, data=,                

    data_len=, flags=) at app-layer.c:452                                                                            

#3  0x000055555558a9f1 in AppLayerHandleTCPData (tv=tv@entry=0x555556c1ea80, ra_ctx=ra_ctx@entry=0x7ffff02a1670, p=p@entry=0x7ffff0268180,         

    f=0x5555568929c0, ssn=ssn@entry=0x7ffff0371f20, stream=stream@entry=0x7ffff5516768,                                                            

    data=0x7ffff04ba2c0 "GET /rockl HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost: 192.168.126

.154\r\nConnection: Keep-Alive\r\n\r\n", data_len=0x93, flags=0x5) at app-layer.c:621                                                              

#4  0x00005555557205aa in ReassembleUpdateAppLayer (dir=, p=, stream=, ssn=,           

    ra_ctx=, tv=) at stream-tcp-reassemble.c:1083                                                                    

#5  StreamTcpReassembleAppLayer (tv=tv@entry=0x555556c1ea80, ra_ctx=ra_ctx@entry=0x7ffff02a1670, ssn=ssn@entry=0x7ffff0371f20,                     

    stream=, stream@entry=0x7ffff0371fb0, p=p@entry=0x7ffff0268180, dir=dir@entry=UPDATE_DIR_OPPOSING)                              

    at stream-tcp-reassemble.c:1140                                                                                                                

#6  0x0000555555721315 in StreamTcpReassembleHandleSegmentUpdateACK (p=0x7ffff0268180, stream=0x7ffff0371fb0, ssn=0x7ffff0371f20,                   

    ra_ctx=0x7ffff02a1670, tv=0x555556c1ea80) at stream-tcp-reassemble.c:1714                                                                      

#7  StreamTcpReassembleHandleSegment (tv=tv@entry=0x555556c1ea80, ra_ctx=0x7ffff02a1670, ssn=ssn@entry=0x7ffff0371f20, stream=0x7ffff0371f30,      

    p=p@entry=0x7ffff0268180, pq=pq@entry=0x7ffff02a1318) at stream-tcp-reassemble.c:1757                                                          

#8  0x0000555555716090 in HandleEstablishedPacketToClient (stt=, pq=, p=, ssn=,        

    tv=) at stream-tcp.c:2445                                                                                                       

#9  StreamTcpPacketStateEstablished (tv=0x555556c1ea80, p=0x7ffff0268180, stt=stt@entry=0x7ffff02a1310, ssn=0x7ffff0371f20, pq=0x7ffff02a1318)     

    at stream-tcp.c:2682                                                                                                                           

#10 0x0000555555719e00 in StreamTcpStateDispatch (tv=0x555556c1ea80, p=0x7ffff0268180, stt=0x7ffff02a1310, ssn=0x7ffff0371f20, pq=0x7ffff02a1318,  

    state=) at stream-tcp.c:4687                                                                                                    

#11 0x000055555571bef3 in StreamTcpPacket (tv=0x555556c1ea80, p=0x7ffff0268180, stt=0x7ffff02a1310, pq=0x7ffff02901d8) at stream-tcp.c:4876        

#12 0x000055555571ca64 in StreamTcp (tv=tv@entry=0x555556c1ea80, p=p@entry=0x7ffff0268180, data=, pq=pq@entry=0x7ffff02901d8,       

    postpq=postpq@entry=0x0) at stream-tcp.c:5212                                                                                                  

#13 0x00005555556a5581 in FlowWorker (tv=0x555556c1ea80, p=0x7ffff0268180, data=0x7ffff02901b0, preq=0x555556c1f470, unused=)       

    at flow-worker.c:245                                                                                                                           

#14 0x000055555572b3ab in TmThreadsSlotVarRun (tv=tv@entry=0x555556c1ea80, p=p@entry=0x7ffff0268180, slot=slot@entry=0x555556c1f2f0)               

    at tm-threads.c:134                                                                                                                            

#15 0x00005555557029a6 in TmThreadsSlotProcessPkt (p=0x7ffff0268180, s=0x555556c1f2f0, tv=0x555556c1ea80) at tm-threads.h:163                      

#16 AFPReadFromRing (ptv=) at source-af-packet.c:1025                                                                               

#17 0x000055555570678e in ReceiveAFPLoop (tv=0x555556c1ea80, data=, slot=) at source-af-packet.c:1589                

#18 0x000055555572f5a1 in TmThreadsSlotPktAcqLoop (td=0x555556c1ea80) at tm-threads.c:360                                                           

#19 0x00007ffff6d9d6db in start_thread (arg=0x7ffff5518700) at pthread_create.c:463                                                                

#20 0x00007ffff620188f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95 

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image010.jpg)

协议解析函数：

TCPProtoDetect

HTPRegisterPatternsForProtocolDetection

协议分析的注册函数：

  HTPRegisterPatternsForProtocolDetection

    RegisterHTPParsers();

    RegisterSSLParsers();

    RegisterDCERPCParsers();

    RegisterDCERPCUDPParsers();

    RegisterSMBParsers();

    RegisterFTPParsers();

    RegisterSSHParsers();

    RegisterSMTPParsers();

    RegisterDNSUDPParsers();

    RegisterDNSTCPParsers();

    RegisterModbusParsers();

    RegisterENIPUDPParsers();

    RegisterENIPTCPParsers();

    RegisterDNP3Parsers();

    RegisterNFSTCPParsers();

    RegisterNFSUDPParsers();

    RegisterNTPParsers();

    RegisterTFTPParsers();

    RegisterIKEV2Parsers();

    RegisterKRB5Parsers();

    RegisterDHCPParsers();

    RegisterSNMPParsers();

    RegisterSIPParsers();

    RegisterTemplateRustParsers();

    RegisterTemplateParsers();

RegisterRdpParsers();

这些都是 协议分析的相关流程。

相关协议的协议解析部分参看这部分内容

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image012.jpg)

以上是suricat粗略的调试，接下来部分是详细记录相关细节：

### 调试相关记录

AppLayerProtoDetectGetProto 函数 协议识别的关键函数

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image014.jpg)

它有两种方式来进行协议识别 分别是 pm模式 pattern 模式 ，另一种是pp模式；

FLOW_IS_PM_DONE

FLOW_IS_PP_DONE

加入先进入PM模式 那么进入的AppLayerProtoDetectPMGetProto

经过一系列判断 比较核心的处理函数是PMGetProtoInspect

里面会有两个回调函数分别是：mpm_table&…

这两个是采用AC算法 对各个特征就行识别.

另外一个是采用pr模式：

AppLayerProtoDetectPPGetProto

 实验：

增加文件src/app-layer-test.h

#ifndef __APP_LAYER_TEST_TCP_H__                                                                                                                                                                                                                                           

#define __APP_LAYER_TEST_TCP_H__                                                                                                                                                                                                                                            

//   RegisterTestParsers()                                                                                                                                                                                                                                                  

void RegisterTestParsers(void);                                                                                                                                                                                                                                             

#endif /* !__APP_LAYER_DNS_TCP_H__ */                                                                                                                                                                                                                                       

src/app-layer-test.c

#include "suricata-common.h"                                                                                                                                                                                                                                                

#include "suricata.h"                                                                                                                                                                                                                                                       

#include "app-layer-protos.h"                                                                                                                                                                                                                                               

#include "app-layer-detect-proto.h"                                                                                                                                                                                                                                         

#include "app-layer-parser.h"                                                                                                                                                                                                                                               

//#include "app-layer-dns-common.h"                                                                                                                                                                                                                                         

//#include "util-unittest.h"                                                                                                                                                                                                                                                

#include "app-layer-test.h"                                                                                                                                                                                                                                                 

//   RegisterTestParsers()                                                                                                                                                                                                                                                  

static int TESTRegisterPatternsForProtocolDetection(void)                                                                                                                                                                                                                   

{                                                                                                                                                                                                                                                                           

    if (AppLayerProtoDetectPMRegisterPatternCI(IPPROTO_TCP, ALPROTO_TEST,                                                                                                                                                                                                   

                                              "FILES", 5, 0, STREAM_TOSERVER) < 0)                                                                                                                                                                                          

    {                                                                                                                                                                                                                                                                       

        return -1;                                                                                                                                                                                                                                                          

    }                                                                                                                                                                                                                                                                       

    return 0;                                                                                                                                                                                                                                                               

}                                                                                                                                                                                                                                                                           

void RegisterTestParsers(void)                                                                                                                                                                                                                                              

{                                                                                                                                                                                                                                                                           

        const char *proto_name = "test";                                                                                                                                                                                                                                    

         if (AppLayerProtoDetectConfProtoDetectionEnabled("tcp", proto_name)) {                                                                                                                                                                                             

                AppLayerProtoDetectRegisterProtocol(ALPROTO_TEST, proto_name);                                                                                                                                                                                             

                if (TESTRegisterPatternsForProtocolDetection() < 0 ){                                                                                                                                                                                                      

                        SCLogNotice("fail to detect TEST\n");                                                                                                                                                                                                              

                      return;}                                                                                                                                                                                                                                             

                 SCLogNotice("sucess to get test\n");                                                                                                                                                                                                                      

                 return;                                                                                                                                                                                                                                                    

    }                                                                                                                                                                                                                                                                       

 return;                                                                                                                                                                                                                                                                    

} 

 在src/make file里面添加需要编译的代码

匹配逻辑截图：

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image016.jpg)

Rockl是规则pattern

GET /rockl HTTP/1.1\r\nUser-Agent: Wget/1.19.4 (linux-gnu)\r\nAccept: */*\r\nAccept-Encoding: identity\r\nHost: www.baidu.com\                                                                                                                        

r\nConnection: Keep-Alive\r\n\r\n

是待匹配的字符串

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image018.jpg)

### Fast_pattern的选取原则

选择一条规则中哪一个匹配条件放入prefilter中，suricata提供了两种方式：

1，显示的指定匹配条件放入prefilter。针对字符串的匹配，即使用MPM多模匹配算法的匹配，使用fast_pattern关键字进行指定。例如，content:"IMSTSWebProxy"; nocase; fast_pattern;则content:"IMSTSWebProxy";会被方放入prefilter中。针对于非字符串的匹配，即non-MPM的匹配，使用prefilter关键字，例如，ttl:123; prefilter;，则ttl:123; 会被方放入prefilter中。

2，使用默认的方式。如果没有像1中的显示指定prefilter，则suricata会根据自己内部的一套方法来选择默认的prefilter。如下：

1，总的原则是肯定的匹配条件优先级高于否定的匹配条件（否定的匹配指的是条件中带有!的匹配）。

2，suricata内部定义了一些关键字buffer的优先级，例如http_method优先级高于http_cookie，在http_method和http_cookie条件同时存在的时候，优先选择http_method作为prefilter。关于这些关键字buffer的优先级，这里。

3，对于像http_uri以及http_host这样具有相同优先级的buffer，则使用匹配条件中长度较长的content作为prefilter.

4，如果第三步中仍然无法确认prefilter，则根据匹配条件content的字符复杂程度进行判断，更为复杂的字符作为prefilter。关于字符串复杂度的判断算法，这里。

5，第4步中仍然无法确认的话，则根据buffer注册的id来进行判断，注册顺序建步骤2的链接。在源码中，buffer部分注册的如下：

多模做前置匹配，后置单模匹配

### 文件还原

![](file:///C:/Users/zhukeyu/AppData/Local/Temp/msohtmlclip1/01/clip_image020.jpg)

FileAppendData

### 参考链接

文件还原的流程：

[https://promisechen.github.io/suricata/review.html](https://promisechen.github.io/suricata/review.html)

文件还原的实验：

[https://promisechen.github.io/suricata/quick_start.html#id2](https://promisechen.github.io/suricata/quick_start.html#id2)