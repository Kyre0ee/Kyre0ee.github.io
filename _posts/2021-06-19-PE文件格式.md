---
layout: post
title: PE文件格式
date: 2021-06-19 09:30
tags: 逆向
excerpt: "本文介绍PE文件格式。"
toc: true
---	
# PE文件格式

PE（Portable Executable）是Windows操作系统上的标准可执行文件格式，用于存储可执行程序、动态链接库（DLL）以及驱动程序等。它是一种灵活的格式，支持32位和64位系统，并提供了丰富的元数据信息和结构化的文件布局，使得Windows系统能够识别、加载和执行这些文件。

## 主要组成部分：

1. DOS头（DOS Header）：

- 包含了16位DOS可执行文件的信息，用于向后兼容性。
- 包括DOS标记、文件大小、入口点等信息。

2. PE头（PE Header）：

- 包含了32位或64位PE文件的基本信息。
- 包括PE标记、文件类型、机器类型、节表偏移等信息。

3. 节表（Section Table）：

- 包含了文件的各个节的信息，如代码段、数据段、资源段等。
- 每个节都有自己的虚拟地址、文件偏移、大小和属性等。

4. 数据段（Data Section）：

- 包含了程序的数据，如全局变量、常量等。
- 可以包含可执行代码和只读数据。

5. 代码段（Code Section）：

- 包含了程序的可执行代码。

6. PE文件的入口点（Entry Point）位于代码段。
7. 导入表（Import Table）：

- 包含了程序依赖的外部函数和库的信息。
- 用于动态链接时解析依赖关系。

8. 导出表（Export Table）：

- 包含了程序导出的函数和符号的信息。
- 用于其他程序调用。

9. 资源表（Resource Table）：

- 包含了程序的资源，如图标、位图、字符串等。
- 资源以树状结构组织。

## PE文件的特点：

- 灵活性：PE文件格式支持32位和64位系统，允许在不同的系统上运行。
- 可扩展性：PE文件格式可以包含丰富的元数据信息和资源，支持数字签名等功能。
- 兼容性：PE文件格式是Windows操作系统的标准格式，可以在各种Windows系统上运行。
- 可读性：PE文件的结构化布局和元数据信息使得对文件进行分析和调试更加方便。

## PE文件头恶意代码注入

在Windows平台上，恶意分析人员经常会利用PE（Portable Executable）文件头进行恶意代码注入。这种技术利用了PE文件格式的一些特性，包括可执行文件的加载方式、节表结构等。以下是几种常见的利用PE文件头进行恶意代码注入的技术：

### 代码注入：

在PE文件的代码段（.text节）中插入恶意代码，通常是在可执行文件的入口点（Entry Point）之后，使恶意代码在程序启动时被执行。
调整可执行文件的入口点，使其指向恶意代码，而非原始的程序入口点。
这种注入方式会改变可执行文件的内容，但可以利用文件的重定位表（relocation table）来解决地址偏移的问题。

### 数据注入：

将恶意代码添加到可执行文件的数据段（.data节）中，或者创建一个新的数据段来存储恶意代码。
这种注入方式可以通过修改PE文件的节表来实现，以适应新增的数据段。

### 重定向注入：

修改PE文件的导入表（Import Table），将原始的DLL导入项指向恶意的DLL或者恶意的API函数。
这种方式不需要修改文件内容，而是修改了文件的加载逻辑，使得恶意代码在运行时被加载和执行。

### 镜像注入：

将整个恶意文件加载到内存中，然后将恶意文件的内容复制到合法的PE文件中，形成一个新的PE文件。
这种方式可以绕过一些简单的安全检测，但需要考虑内存空间的大小和可执行文件的结构。

## 针对这些恶意代码注入技术，防御的方法包括：

- 对文件进行完整性检查，查找和修复被篡改的PE文件。
- 使用反病毒软件对文件进行扫描，检测和清除恶意代码。
- 采用代码签名和数字证书来验证文件的合法性。
- 实施基于行为的检测和防御机制，监视可执行文件的行为并及时响应异常情况。
