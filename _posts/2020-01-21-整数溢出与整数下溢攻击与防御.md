---
layout: post
title: 整数溢出与整数下溢攻击与防御
date: 2020-01-21 09:30
tags: 二进制安全
excerpt: "本文介绍二进制安全漏洞-整数溢出与整数下溢的攻击与防御。"
toc: true
---	
# 整数溢出与整数下溢 (Integer Overflow and Underflow)

## 描述

整数溢出与下溢是指当整数计算结果超过数据类型表示范围时，值会绕回（wrap around）到最小值或最大值。这种情况可能会导致分配错误大小的内存、逻辑错误，甚至安全漏洞。常见的场景包括内存分配、数组索引、循环控制等。

## 整数溢出

当执行整数加法、乘法等操作时，结果超过了数据类型的最大值，结果会从最小值重新开始。例如，对于32位有符号整数，其取值范围是-2,147,483,648到2,147,483,647。当结果超过2,147,483,647时，会绕回到-2,147,483,648。

## 整数下溢

类似地，当执行减法操作时，结果小于数据类型的最小值，结果会从最大值重新开始。例如，对于32位有符号整数，当结果小于-2,147,483,648时，会绕回到2,147,483,647。

## 案例
以下是一个简单的整数溢出漏洞示例：

```c
#include <stdio.h>
#include <stdlib.h>

void vulnerable_function(int size) {
    char *buffer;
    // 整数溢出，如果size为负数，则分配小于期望的内存
    buffer = (char *)malloc(size * sizeof(char));
    if (buffer == NULL) {
        // 错误处理
        return;
    }
    // 使用缓冲区
    free(buffer);
}

int main() {
    int size = -1;
    vulnerable_function(size);
    return 0;
}
```

在这个示例中，如果size为负数，那么size * sizeof(char)将导致整数溢出，分配的内存大小会比期望的小，甚至可能分配0字节。这种情况会导致后续的缓冲区操作出现不可预测的行为，可能会引发安全漏洞。

## 漏洞利用示例

假设攻击者能够控制size的值，通过设置size为负数，攻击者可以导致整数溢出，从而分配错误大小的内存。这可能会导致缓冲区溢出、数据泄露、甚至远程代码执行等严重后果。

## 防御手段
### 检查整数溢出

在执行算术操作前，验证输入值的范围，以确保不会发生溢出或下溢。

```c
void safe_function(int size) {
    if (size <= 0 || size > INT_MAX / sizeof(char)) {
        // 输入值无效，进行错误处理
        fprintf(stderr, "Invalid size\n");
        return;
    }
    char *buffer = (char *)malloc(size * sizeof(char));
    if (buffer == NULL) {
        // 错误处理
        return;
    }
    // 使用缓冲区
    free(buffer);
}
```

### 使用安全库

使用诸如SafeInt库进行整数运算，该库提供了对整数溢出和下溢的检测和处理。

```cpp
#include <safeint.h>

void safe_function(int size) {
    SafeInt<int> safeSize(size);
    try {
        SafeInt<int> bufferSize = safeSize * sizeof(char);
        char *buffer = (char *)malloc(bufferSize);
        if (buffer == NULL) {
            // 错误处理
            return;
        }
        // 使用缓冲区
        free(buffer);
    }
    catch (SafeIntException&) {
        // 捕获整数溢出异常
        fprintf(stderr, "Integer overflow\n");
        return;
    }
}
```

### 使用现代编译器特性

一些现代编译器提供了检测整数溢出的特性，可以在编译时或运行时捕获潜在的问题。

```c
// 使用 -ftrapv 编译选项来启用运行时溢出检查
gcc -ftrapv -o safe_program program.c
```

## 总结

整数溢出与下溢是常见的编程错误，了解其原理并采取相应的防御措施非常重要。通过检查整数溢出、使用安全库和现代编译器特性，可以有效降低整数溢出与下溢的风险，提高程序的安全性。
