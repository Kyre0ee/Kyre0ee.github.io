---
layout: post
title: x86体系结构的系统调用
date: 2021-05-27 09:30
tags: 逆向
excerpt: "本文介绍x86体系结构的系统调用。"
toc: true
---	

# x86 体系结构的系统调用

在 x86 汇编语言中，系统调用是通过软件中断来实现的。在 Linux 操作系统中，通常使用 int 0x80 指令来发出系统调用。系统调用是一种通过操作系统提供的接口来执行特权操作的方法，如文件操作、进程管理、内存管理等。本文将详细介绍 x86 体系结构的系统调用机制，并给出相关示例。

## 基本原理

系统调用通过以下步骤来实现：

- 将系统调用号放入 EAX 寄存器。
- 将系统调用参数放入 EBX、ECX、EDX、ESI 和 EDI 寄存器中。
- 执行 int 0x80 指令，触发中断，进入内核模式。
- 内核根据 EAX 中的系统调用号调用相应的内核函数。
- 内核函数执行完成后，将结果放入 EAX 寄存器，返回用户模式。

## 常见的系统调用

以下是一些常见的系统调用及其对应的调用号：

| 系统调用 | 调用号 | 描述 |
| :--- | :--- | :--- |
| sys_exit	| 1	| 终止进程 |
| sys_fork	| 2	| 创建子进程 |
| sys_read	| 3	| 从文件描述符读取数据 |
| sys_write	| 4	| 向文件描述符写入数据 |
| sys_open	| 5	| 打开文件 |
| sys_close	| 6	| 关闭文件描述符 |

## 示例程序

下面是一个使用系统调用在控制台输出 "Hello, World!" 的 x86 汇编程序示例。

```asm
section .data
    msg db 'Hello, World!', 0xA  ; 定义字符串，并以换行符结尾
    len equ $ - msg              ; 计算字符串长度

section .text
    global _start

_start:
    ; write system call
    mov eax, 4                   ; 系统调用号（sys_write）
    mov ebx, 1                   ; 文件描述符（stdout）
    mov ecx, msg                 ; 指向消息的指针
    mov edx, len                 ; 消息长度
    int 0x80                     ; 调用内核

    ; exit system call
    mov eax, 1                   ; 系统调用号（sys_exit）
    xor ebx, ebx                 ; 退出状态
    int 0x80                     ; 调用内核
```

### 编译和运行

在 Linux 系统下，可以使用 nasm 和 ld 编译并运行上述程序：

1. 保存程序为 hello.asm。
2. 编译程序：

```sh
nasm -f elf32 hello.asm -o hello.o
```

3. 链接程序：

```sh
ld -m elf_i386 hello.o -o hello
```

4.运行程序：

```sh
./hello
```

### 详细说明

* 数据段和代码段：

	- section .data 段用于定义数据，例如字符串。
	- section .text 段用于定义代码。
* 全局入口点：

	- global _start 定义程序的入口点 _start。

* 系统调用实现：

	- mov eax, 4：将系统调用号（sys_write 的调用号是 4）放入 EAX 寄存器。
	- mov ebx, 1：将文件描述符（stdout 是 1）放入 EBX 寄存器。
	- mov ecx, msg：将字符串地址放入 ECX 寄存器。
	- mov edx, len：将字符串长度放入 EDX 寄存器。
	- int 0x80：触发中断，进行系统调用。
	- mov eax, 1：将系统调用号（sys_exit 的调用号是 1）放入 EAX 寄存器。
	- xor ebx, ebx：将退出状态设为 0。
	- int 0x80：触发中断，终止程序。

## 小结

通过以上内容，详细介绍了 x86 体系结构中的系统调用机制，包括系统调用的基本原理、常见的系统调用及其对应的调用号，以及如何编写和运行一个简单的汇编程序。掌握这些知识和技巧，可以帮助你更好地理解和使用 x86 汇编语言进行系统编程。
